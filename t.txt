import { Migration } from '@mikro-orm/migrations';

export class Migration20201001165103 extends Migration {

  async up(): Promise<void> {
    this.addSql('alter table "variables" drop constraint if exists "variables_enabled_check";');
    this.addSql('alter table "variables" alter column "enabled" type bool using ("enabled"::bool);');
    this.addSql('alter table "variables" alter column "enabled" drop default;');

    this.addSql('alter table "users" drop constraint if exists "users_watched_check";');
    this.addSql('alter table "users" alter column "watched" type int8 using ("watched"::int8);');
    this.addSql('alter table "users" alter column "watched" set default 0;');
    this.addSql('alter table "users" drop constraint if exists "users_lastMessagePoints_check";');
    this.addSql('alter table "users" alter column "lastMessagePoints" type int8 using ("lastMessagePoints"::int8);');
    this.addSql('alter table "users" alter column "lastMessagePoints" set default 0;');
    this.addSql('alter table "users" drop constraint if exists "users_lastWatchedPoints_check";');
    this.addSql('alter table "users" alter column "lastWatchedPoints" type int8 using ("lastWatchedPoints"::int8);');
    this.addSql('alter table "users" alter column "lastWatchedPoints" set default 0;');

    this.addSql('alter table "users_daily_messages" drop constraint if exists "users_daily_messages_count_check";');
    this.addSql('alter table "users_daily_messages" alter column "count" type int4 using ("count"::int4);');
    this.addSql('alter table "users_daily_messages" alter column "count" set default 0;');

    this.addSql('alter table "timers" drop constraint if exists "timers_last_check";');
    this.addSql('alter table "timers" alter column "last" type int4 using ("last"::int4);');
    this.addSql('alter table "timers" alter column "last" drop default;');

    this.addSql('create table "songs_likes" ("id" serial primary key, "userId" int4 not null, "name" varchar(255) not null, "createdAt" int8 not null, "updatedAt" int8 null);');

    this.addSql('alter table "commands" add column "sound_file_id" int4 null, add column "sound_volume" int4 null;');
    this.addSql('alter table "commands" drop constraint if exists "commands_cooldown_check";');
    this.addSql('alter table "commands" alter column "cooldown" type int4 using ("cooldown"::int4);');
    this.addSql('alter table "commands" alter column "cooldown" set default 10;');
    this.addSql('alter table "commands" drop constraint if exists "commands_enabled_check";');
    this.addSql('alter table "commands" alter column "enabled" drop default;');
    this.addSql('alter table "commands" alter column "enabled" type bool using ("enabled"::bool);');
    this.addSql('alter table "commands" alter column "enabled" set default true;');
    this.addSql('alter table "commands" alter column "enabled" set not null;');
    this.addSql('alter table "commands" drop constraint if exists "commands_usage_check";');
    this.addSql('alter table "commands" alter column "usage" type int4 using ("usage"::int4);');
    this.addSql('alter table "commands" alter column "usage" set default 0;');

    this.addSql('alter table "songs_likes" add constraint "songs_likes_user_foreign" foreign key ("user") references "users" ("id") on update cascade on delete set null;');

    this.addSql('alter table "songs_likes" add constraint "songs_likes_userid_name_unique" unique ("userId", "name");');
  }

}


DROP TABLE IF EXISTS "mikro_orm_migrations";
DROP SEQUENCE IF EXISTS mikro_orm_migrations_id_seq;
CREATE SEQUENCE mikro_orm_migrations_id_seq INCREMENT 1 MINVALUE 1 MAXVALUE 2147483647 START 2 CACHE 1;

CREATE TABLE "public"."mikro_orm_migrations" (
    "id" integer DEFAULT nextval('mikro_orm_migrations_id_seq') NOT NULL,
    "name" character varying(255),
    "executed_at" timestamptz DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "mikro_orm_migrations_pkey" PRIMARY KEY ("id")
) WITH (oids = false);

INSERT INTO "mikro_orm_migrations" ("id", "name", "executed_at") VALUES
(1,	'Migration20201001165024.ts',	'2020-10-01 17:16:47.189835+00');